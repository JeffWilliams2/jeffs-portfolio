---
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn } from '@/lib/utils'
import type { MarkdownHeading } from 'astro'
import { Icon } from 'astro-icon/components'

type Props = {
  headings: MarkdownHeading[]
}

const { headings } = Astro.props

function getHeadingMargin(depth: number): string {
  const margins: Record<number, string> = {
    3: 'ml-4',
    4: 'ml-8',
    5: 'ml-12',
    6: 'ml-16',
  }
  return margins[depth] || ''
}

function cleanupHeading(text: string): string {
  text = text.replace(/&lt;/g, '<').replace(/&gt;/g, '>')
  text = text.replace(/&amp;/g, '&').replace(/&quot;/g, '"')
  text = text.replace(/&#39;/g, "'").replace(/&apos;/g, "'")
  text = text.replace(/:/g, '')
  text = text.replace(/,/g, '')
  return text.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ')
}
---

<details class="toc-wrapper group">
  <summary class="cursor-pointer list-none flex items-center gap-2 mb-6 pb-3 border-b border-zinc-200 dark:border-zinc-800">
    <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
    <span class="text-base font-semibold text-zinc-900 dark:text-zinc-100">Table of Contents</span>
    <svg class="w-4 h-4 text-zinc-500 transition-transform group-open:rotate-180 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </summary>
  <nav>
    <ul class="space-y-1 text-sm" id="table-of-contents">
      {headings.map((heading) => (
        <li class={cn(
          'text-zinc-600 dark:text-zinc-400',
          getHeadingMargin(heading.depth)
        )}>
          <a
            href={`#${heading.slug}`}
            class="hover:text-emerald-600 dark:hover:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-950/20 transition-all block py-2 px-3 rounded-md toc-link"
            aria-label={`Jump to ${heading.text}`}
          >
            {cleanupHeading(heading.text)}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</details>

<script>
  function setupToc() {
    // Smooth scroll for TOC links
    document.querySelectorAll('.toc-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault()
        const targetId = link.getAttribute('href')?.slice(1)
        if (targetId) {
          const target = document.getElementById(targetId)
          if (target) {
            const offset = 80 // offset for fixed header
            const elementPosition = target.getBoundingClientRect().top
            const offsetPosition = elementPosition + window.pageYOffset - offset

            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            })
          }
        }
      })
    })

    // Track active section
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.getAttribute('id')
            // Remove active from all links
            document.querySelectorAll('.toc-link').forEach(link => {
              link.classList.remove('text-emerald-600', 'dark:text-emerald-400', 'font-medium')
            })
            // Add active to current link
            const activeLink = document.querySelector(`.toc-link[href="#${id}"]`)
            if (activeLink) {
              activeLink.classList.add('text-emerald-600', 'dark:text-emerald-400', 'font-medium')
            }
          }
        })
      },
      {
        rootMargin: '-100px 0px -66%',
        threshold: 0
      }
    )

    // Observe all headings
    document.querySelectorAll('article h2, article h3, article h4, article h5, article h6').forEach((heading) => {
      if (heading.id) {
        observer.observe(heading)
      }
    })
  }

  document.addEventListener('astro:page-load', setupToc)
  document.addEventListener('astro:after-swap', setupToc)
</script>

<style>
  html {
    scroll-behavior: smooth;
  }
</style>
